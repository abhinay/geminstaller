CRUISECONTROL_DIR=/home/woolley/workspace/geminstaller_ci
CRUISECONTROL_CMD=$CRUISECONTROL_DIR/cruise
PIDFILE=/tmp/cruisecontrol.pid

if [ "$CRUISECONTROL_USER" = "" ] ; then
  CRUISECONTROL_USER=cruisecontrol
fi

if [ "$JAVA_HOME" = "" ] ; then
  export JAVA_HOME=/usr/java/jdk
fi
export PATH=$PATH:$JAVA_HOME/bin

case "$1" in
  start)
    echo -n "Starting CruiseControl"
    cd $CRUISECONTROL_DIR
    start-stop-daemon --start --pidfile $PIDFILE --make-pidfile --user $CRUISECONTROL_USER --chuid $CRUISECONTROL_USER --chdir /home/woolley/workspace/geminstaller_ci --exec $CRUISECONTROL_CMD -- start  >> /var/log/cruisecontrol/cruisecontrol.log 2>&1 &
    echo "."
    ;;
  stop)
    echo "Stopping CruiseControl"
    PARPID=`cat $PIDFILE`
    if [ "$PARPID" = "" ] ; then
      echo "No pidfile found for cruisecontrol, nothing to stop"
      exit 1
    fi
    start-stop-daemon --stop --quiet --pidfile $PIDFILE
    echo "."
    CHILDPIDS=`ps -ea -o "pid ppid args" | grep -v grep | grep "${PARPID}" | grep -v "^ ${PARPID}" | \
      sed -e 's/^  *//' -e 's/ .*//'`
    if [ "${CHILDPIDS}" != "" ]; then
      echo "Killing child processes: $CHILDPIDS"
      kill -9 ${CHILDPIDS}
      echo "Done killing child processes."
    else
      echo "No child processes killed."
    fi
    ;;
  restart)
    $0 stop
    sleep 2
    $0 start
    ;;
  *)
        echo "Usage: /etc/init.d/cruisecontrol {start|stop|restart}"
        exit 1
esac

exit 0
